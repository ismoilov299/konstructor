# modul/bot/main_bot/handlers/create_bot.py (to'liq versiya)
"""
Main bot orqali yangi bot yaratish handlerlari
"""

import re
import logging
import aiohttp
from aiogram import Router, F
from aiogram.types import Message, CallbackQuery, InlineKeyboardButton, InlineKeyboardMarkup
from aiogram.fsm.context import FSMContext
from aiogram.filters import StateFilter
from asgiref.sync import sync_to_async

from modul.bot.main_bot.services.user_service import (
    get_user_by_uid, create_bot, get_bot_info_from_telegram,
    set_bot_webhook, validate_bot_token
)
from modul.bot.main_bot.states import CreateBotStates
from modul.config import settings_conf

logger = logging.getLogger(__name__)

create_bot_router = Router()


# Keyboard funksiyalari
async def create_bot_menu():
    """Bot yaratish menyu klaviaturasi"""
    buttons = [
        [InlineKeyboardButton(text="üìù Bot tokenini kiriting", callback_data="enter_token")],
        [InlineKeyboardButton(text="‚ùì Token qanday olish?", callback_data="token_help")],
        [InlineKeyboardButton(text="‚óÄÔ∏è Orqaga", callback_data="back_to_main")]
    ]
    return InlineKeyboardMarkup(inline_keyboard=buttons)


async def bot_modules_menu(selected_modules=None):
    """Bot modullari tanlash klaviaturasi"""
    if selected_modules is None:
        selected_modules = {}

    # Module ro'yxati va ularning ko'rinishi
    modules = [
        ("refs", "üí∏ Referral tizimi"),
        ("kino", "üé¨ Kino bot"),
        ("music", "üéµ Musiqa bot"),
        ("download", "üì• Download bot"),
        ("chatgpt", "üí¨ ChatGPT"),
        ("leo", "‚ù§Ô∏è Tanishuv (Leo)"),
        ("horoscope", "üîÆ Munajjimlik"),
        ("anon", "üë§ Anonim chat"),
        ("sms", "üì± SMS yuborish")
    ]

    buttons = []
    for module_key, module_name in modules:
        # Module yoqilgan bo'lsa ‚úÖ, aks holda ‚¨ú
        icon = "‚úÖ" if selected_modules.get(module_key, False) else "‚¨ú"
        text = f"{icon} {module_name}"
        buttons.append([InlineKeyboardButton(
            text=text,
            callback_data=f"toggle_{module_key}"
        )])

    # Qo'shimcha tugmalar
    buttons.append([InlineKeyboardButton(text="‚úÖ Saqlash va yaratish", callback_data="save_bot_config")])
    buttons.append([InlineKeyboardButton(text="‚óÄÔ∏è Orqaga", callback_data="back_to_main")])

    return InlineKeyboardMarkup(inline_keyboard=buttons)


async def back_to_modules_menu():
    """Modullar menyusiga qaytish klaviaturasi"""
    buttons = [
        [InlineKeyboardButton(text="‚óÄÔ∏è Modullarni tanlashga qaytish", callback_data="select_modules")]
    ]
    return InlineKeyboardMarkup(inline_keyboard=buttons)


# Handler'lar
@create_bot_router.callback_query(F.data == "create_bot")
async def start_create_bot(callback: CallbackQuery, state: FSMContext):
    """Bot yaratishni boshlash"""
    await state.clear()  # Avvalgi ma'lumotlarni tozalash

    await callback.message.edit_text(
        "ü§ñ <b>Yangi bot yaratish</b>\n\n"
        "üìã <b>Bot yaratish jarayoni:</b>\n"
        "1Ô∏è‚É£ @BotFather dan bot tokeni olasiz\n"
        "2Ô∏è‚É£ Tokenni bizga berasiz\n"
        "3Ô∏è‚É£ Kerakli modullarni tanlaysiz\n"
        "4Ô∏è‚É£ Bot tayyor!\n\n"
        "üéØ <b>Afzalliklari:</b>\n"
        "‚Ä¢ Bir necha daqiqada tayyor bot\n"
        "‚Ä¢ 9 ta professional modul\n"
        "‚Ä¢ Avtomatik webhook sozlash\n"
        "‚Ä¢ To'liq boshqaruv paneli\n\n"
        "üîê <b>Token formati:</b>\n"
        "<code>1234567890:XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX</code>",
        reply_markup=await create_bot_menu(),
        parse_mode="HTML"
    )
    await callback.answer()


@create_bot_router.callback_query(F.data == "enter_token")
async def request_token(callback: CallbackQuery, state: FSMContext):
    """Token kiritishni so'rash"""
    await state.set_state(CreateBotStates.waiting_for_token)
    await callback.message.edit_text(
        "üìù <b>Bot tokenini kiriting:</b>\n\n"
        "‚ö†Ô∏è <b>Muhim xavfsizlik qoidalari:</b>\n"
        "‚Ä¢ Tokenni faqat @BotFather dan oling\n"
        "‚Ä¢ Hech kimga bermang - bu maxfiy ma'lumot!\n"
        "‚Ä¢ Screenshot olayotganda tokenni yashiring\n"
        "‚Ä¢ Agar token buzilsa, /revoke buyrug'i bilan yangilang\n\n"
        "üî§ <b>Token kiriting:</b>\n"
        "Tokenni to'g'ri ko'chirib joylashtiring ‚Üì",
        parse_mode="HTML"
    )
    await callback.answer()


@create_bot_router.callback_query(F.data == "token_help")
async def show_token_help(callback: CallbackQuery):
    """Token olish bo'yicha yordam"""
    help_text = (
        "‚ùì <b>Bot token qanday olish?</b>\n\n"
        "üì± <b>Qadamlar:</b>\n"
        "1Ô∏è‚É£ @BotFather ga /start yuboring\n"
        "2Ô∏è‚É£ /newbot buyrug'ini yuboring\n"
        "3Ô∏è‚É£ Bot uchun nom kiriting\n"
        "   Masalan: <code>Mening Ajoyib Botim</code>\n"
        "4Ô∏è‚É£ Bot uchun username kiriting\n"
        "   Masalan: <code>my_awesome_bot</code>\n"
        "   (bot bilan tugashi shart!)\n"
        "5Ô∏è‚É£ BotFather sizga token yuboradi\n\n"
        "‚ö° <b>Tezkor havolalar:</b>\n"
        "‚Ä¢ @BotFather - bot yaratish\n"
        "‚Ä¢ /help - BotFather yordam\n"
        "‚Ä¢ /mybots - sizning botlaringiz\n\n"
        "‚ö†Ô∏è <b>Eslatma:</b>\n"
        "Token - bu botingizning 'paroli'. Uni\n"
        "hech kimga bermang va xavfsiz saqlang!"
    )

    await callback.message.edit_text(
        help_text,
        reply_markup=await create_bot_menu(),
        parse_mode="HTML"
    )
    await callback.answer()


@create_bot_router.message(StateFilter(CreateBotStates.waiting_for_token))
async def process_token(message: Message, state: FSMContext):
    """Kiritilgan tokenni qayta ishlash"""
    token = message.text.strip()

    # Token formatini tekshirish (to'liq pattern)
    if not re.match(r'^\d{8,10}:[A-Za-z0-9_-]{35}$', token):
        await message.answer(
            "‚ùå <b>Noto'g'ri token formati!</b>\n\n"
            "Token quyidagi formatda bo'lishi kerak:\n"
            "<code>1234567890:AAHfn3yN8ZSN9JXOp4RgQOtHqEbWr-abc</code>\n\n"
            "‚úÖ <b>To'g'ri format:</b>\n"
            "‚Ä¢ Raqamlar : Harflar va belgilar\n"
            "‚Ä¢ 35 ta belgi ikkinchi qismda\n"
            "‚Ä¢ Faqat A-Z, a-z, 0-9, _, - belgilar\n\n"
            "üîÑ Qaytadan urinib ko'ring yoki /start bosing:",
            parse_mode="HTML"
        )
        return

    # Token allaqachon ishlatilganmi tekshirish
    is_valid, error_message = await validate_bot_token(token)
    if not is_valid:
        await message.answer(
            f"‚ùå <b>Token xatoligi!</b>\n\n"
            f"üîç <b>Sabab:</b> {error_message}\n\n"
            f"üí° <b>Yechim:</b>\n"
            f"‚Ä¢ Boshqa tokendan foydalaning\n"
            f"‚Ä¢ Yoki mavjud botni @BotFather da o'chiring\n\n"
            f"üîÑ Boshqa token kiriting yoki /start bosing:",
            parse_mode="HTML"
        )
        return

    # Bot ma'lumotlarini Telegram'dan olish
    try:
        # Loading animation
        loading_msg = await message.answer("‚è≥ <b>Token tekshirilmoqda...</b>", parse_mode="HTML")

        bot_info = await get_bot_info_from_telegram(token)
        if not bot_info:
            await loading_msg.edit_text(
                "‚ùå <b>Token noto'g'ri yoki bot mavjud emas!</b>\n\n"
                "üîç <b>Sabablari:</b>\n"
                "‚Ä¢ Token noto'g'ri ko'chirilgan\n"
                "‚Ä¢ Bot @BotFather da o'chirilgan\n"
                "‚Ä¢ Internet aloqasi muammosi\n\n"
                "üí° <b>Yechim:</b>\n"
                "‚Ä¢ Tokenni qaytadan tekshiring\n"
                "‚Ä¢ @BotFather da bot mavjudligini tasdiqlang\n\n"
                "üîÑ Qaytadan urinib ko'ring:",
                parse_mode="HTML"
            )
            return

        if not bot_info.get('is_bot', False):
            await loading_msg.edit_text(
                "‚ùå <b>Bu bot tokeni emas!</b>\n\n"
                "ü§ñ Faqat bot tokenlari qabul qilinadi.\n"
                "Oddiy foydalanuvchi tokenlari ishlamaydi.\n\n"
                "üìù @BotFather dan bot yaratib, uni tokenini kiriting:",
                parse_mode="HTML"
            )
            return

        # Ma'lumotlarni state'ga saqlash
        await state.update_data(
            token=token,
            bot_username=bot_info['username'],
            bot_name=bot_info['first_name'],
            bot_id=bot_info['id']
        )

        await state.set_state(CreateBotStates.configuring_modules)

        await loading_msg.edit_text(
            f"‚úÖ <b>Bot muvaffaqiyatli topildi!</b>\n\n"
            f"ü§ñ <b>Nomi:</b> {bot_info['first_name']}\n"
            f"üìõ <b>Username:</b> @{bot_info['username']}\n"
            f"üÜî <b>ID:</b> <code>{bot_info['id']}</code>\n\n"
            f"üîß <b>Endi bot uchun modullarni tanlang:</b>\n"
            f"Har bir modul botingizga alohida funksiya qo'shadi.\n"
            f"Kerakli modullarni belgilang va saqlang.",
            reply_markup=await bot_modules_menu(),
            parse_mode="HTML"
        )

    except Exception as e:
        logger.error(f"Error processing token {token}: {e}")
        await message.answer(
            "‚ùå <b>Texnik xatolik yuz berdi!</b>\n\n"
            "üîß <b>Bu vaqtincha muammo bo'lishi mumkin.</b>\n"
            "Iltimos, qaytadan urinib ko'ring.\n\n"
            "Agar muammo davom etsa, qo'llab-quvvatlash\n"
            "xizmati bilan bog'laning: @support_username",
            parse_mode="HTML"
        )


@create_bot_router.callback_query(F.data.startswith("toggle_"))
async def toggle_module(callback: CallbackQuery, state: FSMContext):
    """Modulni yoqish/o'chirish"""
    module_name = callback.data.replace("toggle_", "")

    data = await state.get_data()
    modules = data.get('modules', {})

    # Module holatini o'zgartirish
    modules[module_name] = not modules.get(module_name, False)
    await state.update_data(modules=modules)

    # Keyboard'ni yangilash
    await callback.message.edit_reply_markup(
        reply_markup=await bot_modules_menu(selected_modules=modules)
    )

    # Feedback berish
    module_names = {
        'refs': 'Referral tizimi',
        'kino': 'Kino bot',
        'music': 'Musiqa bot',
        'download': 'Download bot',
        'chatgpt': 'ChatGPT',
        'leo': 'Tanishuv (Leo)',
        'horoscope': 'Munajjimlik',
        'anon': 'Anonim chat',
        'sms': 'SMS yuborish'
    }

    module_display_name = module_names.get(module_name, module_name)
    status = "yoqildi" if modules[module_name] else "o'chirildi"

    await callback.answer(f"‚úÖ {module_display_name} {status}")


@create_bot_router.callback_query(F.data == "select_modules")
async def back_to_modules_selection(callback: CallbackQuery, state: FSMContext):
    """Modullar tanloviga qaytish"""
    data = await state.get_data()
    modules = data.get('modules', {})

    await callback.message.edit_text(
        f"üîß <b>Bot: @{data.get('bot_username', 'unknown')}</b>\n\n"
        f"<b>Modullarni tanlang:</b>\n"
        f"Har bir modul botingizga alohida funksiya qo'shadi.\n\n"
        f"‚úÖ Yashil belgi - modul yoqilgan\n"
        f"‚¨ú Kulrang belgi - modul o'chiq\n\n"
        f"Modulni yoqish/o'chirish uchun ustiga bosing.",
        reply_markup=await bot_modules_menu(selected_modules=modules),
        parse_mode="HTML"
    )
    await callback.answer()


@create_bot_router.callback_query(F.data == "save_bot_config")
async def save_bot_config(callback: CallbackQuery, state: FSMContext):
    """Bot konfiguratsiyasini saqlash"""
    data = await state.get_data()

    if not all(key in data for key in ['token', 'bot_username', 'bot_name']):
        await callback.message.edit_text(
            "‚ùå <b>Ma'lumotlar noto'liq!</b>\n\n"
            "Iltimos, qaytadan boshlang va barcha\n"
            "bosqichlarni to'g'ri bajaring.",
            reply_markup=await create_bot_menu(),
            parse_mode="HTML"
        )
        await callback.answer()
        return

    try:
        # Progress animation
        progress_msg = await callback.message.edit_text(
            "‚è≥ <b>Bot yaratilmoqda...</b>\n\n"
            "üîÑ <b>Jarayonlar:</b>\n"
            "‚Ä¢ ‚úÖ Ma'lumotlar tekshirildi\n"
            "‚Ä¢ üîÑ Bot bazaga saqlanmoqda...\n"
            "‚Ä¢ ‚è≥ Webhook o'rnatilmoqda...\n"
            "‚Ä¢ ‚è≥ Modullar konfiguratsiya qilinmoqda...",
            parse_mode="HTML"
        )

        # Foydalanuvchini tekshirish
        user = await get_user_by_uid(callback.from_user.id)
        if not user:
            await progress_msg.edit_text(
                "‚ùå <b>Foydalanuvchi topilmadi!</b>\n\n"
                "Iltimos, /start bosib qaytadan ro'yxatdan o'ting.",
                parse_mode="HTML"
            )
            await callback.answer()
            return

        # Bot yaratish
        modules = data.get('modules', {})

        new_bot = await create_bot(
            owner_uid=callback.from_user.id,
            token=data['token'],
            username=data['bot_username'],
            bot_name=data['bot_name'],  # Bu parametr ishlatilmaydi, lekin bor
            modules=modules
        )

        if not new_bot:
            await progress_msg.edit_text(
                "‚ùå <b>Bot yaratishda xatolik!</b>\n\n"
                "Bu vaqtincha texnik muammo bo'lishi mumkin.\n"
                "Iltimos, qaytadan urinib ko'ring.\n\n"
                "Agar muammo davom etsa, qo'llab-quvvatlash\n"
                "bilan bog'laning: @support_username",
                reply_markup=await create_bot_menu(),
                parse_mode="HTML"
            )
            await callback.answer()
            return

        # Progress update
        await progress_msg.edit_text(
            "‚è≥ <b>Bot yaratilmoqda...</b>\n\n"
            "üîÑ <b>Jarayonlar:</b>\n"
            "‚Ä¢ ‚úÖ Ma'lumotlar tekshirildi\n"
            "‚Ä¢ ‚úÖ Bot bazaga saqlandi\n"
            "‚Ä¢ üîÑ Webhook o'rnatilmoqda...\n"
            "‚Ä¢ ‚è≥ Modullar konfiguratsiya qilinmoqda...",
            parse_mode="HTML"
        )

        # Webhook o'rnatish
        webhook_url = settings_conf.WEBHOOK_URL.format(token=data['token'])
        webhook_success = await set_bot_webhook(data['token'], webhook_url)

        # Final progress
        await progress_msg.edit_text(
            "‚è≥ <b>Bot yaratilmoqda...</b>\n\n"
            "üîÑ <b>Jarayonlar:</b>\n"
            "‚Ä¢ ‚úÖ Ma'lumotlar tekshirildi\n"
            "‚Ä¢ ‚úÖ Bot bazaga saqlandi\n"
            f"‚Ä¢ {'‚úÖ' if webhook_success else '‚ö†Ô∏è'} Webhook {'ornatildi' if webhook_success else 'xatolik'}\n"
            "‚Ä¢ ‚úÖ Modullar konfiguratsiya qilindi",
            parse_mode="HTML"
        )

        # Natija
        enabled_modules = []
        module_names = {
            'refs': 'üí∏ Referral tizimi',
            'kino': 'üé¨ Kino bot',
            'music': 'üéµ Musiqa bot',
            'download': 'üì• Download bot',
            'chatgpt': 'üí¨ ChatGPT',
            'leo': '‚ù§Ô∏è Tanishuv',
            'horoscope': 'üîÆ Munajjimlik',
            'anon': 'üë§ Anonim chat',
            'sms': 'üì± SMS yuborish'
        }

        for module, enabled in modules.items():
            if enabled:
                enabled_modules.append(module_names.get(module, module))

        modules_text = "\n".join(
            [f"  ‚úÖ {module}" for module in enabled_modules]) if enabled_modules else "  ‚ùå Hech qanday modul yoqilmagan"
        webhook_status = "‚úÖ Muvaffaqiyatli" if webhook_success else "‚ö†Ô∏è Xatolik (keyinroq qayta uriniladi)"

        await state.clear()

        success_text = (
            f"üéâ <b>Bot muvaffaqiyatli yaratildi!</b>\n\n"
            f"ü§ñ <b>Bot ma'lumotlari:</b>\n"
            f"‚Ä¢ <b>Username:</b> @{data['bot_username']}\n"
            f"‚Ä¢ <b>Nomi:</b> {data['bot_name']}\n"
            f"‚Ä¢ <b>ID:</b> <code>{data.get('bot_id', 'N/A')}</code>\n\n"
            f"üåê <b>Webhook:</b> {webhook_status}\n\n"
            f"üîß <b>Yoqilgan modullar:</b>\n{modules_text}\n\n"
            f"üöÄ <b>Bot havolasi:</b>\n"
            f"https://t.me/{data['bot_username']}\n\n"
            f"‚ú® <b>Botingiz tayyor va foydalanishga darhol yaroqli!</b>\n"
            f"Modullar avtomatik ishga tushgan."
        )

        await progress_msg.edit_text(
            success_text,
            reply_markup=InlineKeyboardMarkup(inline_keyboard=[
                [InlineKeyboardButton(text="üîó Botni ochish", url=f"https://t.me/{data['bot_username']}")],
                [InlineKeyboardButton(text="ü§ñ Mening botlarim", callback_data="my_bots")],
                [InlineKeyboardButton(text="‚ûï Yana bot yaratish", callback_data="create_bot")],
                [InlineKeyboardButton(text="üè† Asosiy menyu", callback_data="back_to_main")]
            ]),
            parse_mode="HTML"
        )

        # Success log
        logger.info(f"Bot created successfully: @{data['bot_username']} for user {callback.from_user.id}")

    except Exception as e:
        logger.error(f"Error saving bot config: {e}")
        await callback.message.edit_text(
            f"‚ùå <b>Bot yaratishda xatolik!</b>\n\n"
            f"üîç <b>Xatolik tafsiloti:</b>\n"
            f"<code>{str(e)}</code>\n\n"
            f"üí° <b>Yechim:</b>\n"
            f"‚Ä¢ Qaytadan urinib ko'ring\n"
            f"‚Ä¢ Agar muammo davom etsa, qo'llab-quvvatlash\n"
            f"  bilan bog'laning: @support_username",
            reply_markup=await create_bot_menu(),
            parse_mode="HTML"
        )

    await callback.answer()


# Cancel handler
@create_bot_router.message(StateFilter(CreateBotStates.waiting_for_token),
                           F.text.in_(["/start", "/cancel", "‚ùå–û—Ç–º–µ–Ω–∏—Ç—å"]))
async def cancel_token_input(message: Message, state: FSMContext):
    """Token kiritishni bekor qilish"""
    await state.clear()
    await message.answer(
        "‚ùå <b>Bot yaratish bekor qilindi.</b>\n\n"
        "Istalgan vaqtda qaytadan boshlashingiz mumkin.",
        reply_markup=InlineKeyboardMarkup(inline_keyboard=[
            [InlineKeyboardButton(text="üè† Asosiy menyu", callback_data="back_to_main")]
        ]),
        parse_mode="HTML"
    )


# Error handler for any other text during token waiting
@create_bot_router.message(StateFilter(CreateBotStates.waiting_for_token))
async def invalid_token_format(message: Message, state: FSMContext):
    """Noto'g'ri token format handleri"""
    await message.answer(
        "‚ùå <b>Noto'g'ri token!</b>\n\n"
        "üî§ Token faqat raqamlar, harflar va maxsus belgilardan iborat bo'lishi kerak.\n\n"
        "üìù To'g'ri format:\n"
        "<code>1234567890:AAHfn3yN8ZSN9JXOp4RgQOtHqEbWr-abc</code>\n\n"
        "üí° @BotFather dan to'g'ri tokenni ko'chirib joylashtiring.",
        parse_mode="HTML"
    )